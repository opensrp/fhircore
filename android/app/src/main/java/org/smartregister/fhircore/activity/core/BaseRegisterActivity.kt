/*
 * Copyright 2021 Ona Systems, Inc
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.smartregister.fhircore.activity.core

import android.os.Bundle
import androidx.annotation.LayoutRes
import androidx.core.widget.doAfterTextChanged
import androidx.fragment.app.Fragment
import androidx.fragment.app.FragmentActivity
import androidx.viewpager2.adapter.FragmentStateAdapter
import org.smartregister.fhircore.R
import org.smartregister.fhircore.model.BaseRegister
import org.smartregister.fhircore.util.Utils
import org.smartregister.fhircore.util.Utils.addOnDrawableClickedListener

abstract class BaseRegisterActivity : BaseDrawerActivity() {
  val register by lazy { buildRegister() }

  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    setUpViews()
  }

  @LayoutRes
  override fun getContentLayout(): Int {
    return register.contentLayoutId
  }

  abstract fun buildRegister(): BaseRegister

  protected fun setUpViews() {
    setupRegistrationView()

    setupPager()

    setupSearchBox()
  }

  protected fun setupRegistrationView() {
    register.newRegistrationView()?.setOnClickListener { startRegistrationActivity(null) }
  }

  protected fun setupPager() {
    register.viewPager().adapter = PagerAdapter(this)
  }

  protected fun setupSearchBox() {
    var editText = register.searchBox() ?: return

    editText.doAfterTextChanged {
      if (it!!.isEmpty()) {
        editText.setOnTouchListener(null)
        editText.setCompoundDrawablesWithIntrinsicBounds(
          getDrawable(R.drawable.ic_search),
          null,
          null,
          null
        )
      } else {
        editText.setCompoundDrawablesWithIntrinsicBounds(
          null,
          null,
          getDrawable(R.drawable.ic_cancel),
          null
        )
        editText.addOnDrawableClickedListener(Utils.DrawablePosition.DRAWABLE_RIGHT) { it.clear() }
      }
    }
  }

  fun startRegistrationActivity(preAssignedId: String?) {
    val questionnaireId = register.newRegistrationQuestionnaireIdentifier!!
    val questionnaireTitle =
      register.newRegistrationQuestionnaireTitle ?: getString(R.string.client_info)

    startQuestionnaire(questionnaireTitle, questionnaireId, preAssignedId, true)
  }

  private inner class PagerAdapter(fa: FragmentActivity) : FragmentStateAdapter(fa) {
    override fun getItemCount(): Int {
      return 1
    }

    override fun createFragment(position: Int): Fragment {
      return register.listFragment
    }
  }
}
