map "http://hl7.org/fhir/StructureMap/385988" = 'IPC Activity'

uses "http://hl7.org/fhir/StructureDefinition/Parameters" as source
uses "http://hl7.org/fhir/StructureDefinition/CarePlan" as target

group IPCSchedule(source src : Parameters, target careplan: CarePlan) {
    src -> evaluate(src, $this.parameter.where(name='subject').resource) as subject,
            evaluate(src, $this.parameter.where(name='definition').resource) as definition,
            evaluate(src, $this.parameter.where(name='depends-on').resource.entry.where(resource is QuestionnaireResponse).resource) as questionnaireResponse,
            evaluate(src, $this.parameter.where(name='period').value) as period,
            evaluate(src, $this.parameter.where(name='version').value) as version
            then extractTask(period, version, subject, definition, careplan) "rule_careplan";
}

group extractTask(
    source period: Period,
    source version: Integer,
    source subject : Patient,
    source definition: ActivityDefinition,
    target careplan: CarePlan) {

    // fill task into careplan contained and add reference in activity.outcome
    subject -> create('Task') as task,
        // dosage[version] does not work, hence skipping the item from given index via skip.first
        evaluate(definition, $this.dosage.skip(version).first()) as currentDose then {
        subject -> task.id = uuid(),
               task.identifier = create('Identifier') as iden, iden.value = uuid(), iden.use = 'official',
               //task.status = 'requested',
               task.intent = 'plan',
               task.executionPeriod = period,
               task.priority = 'routine',
               // dosage[version] does not work, hence skipping the item from given index via skip.first
               task.description = evaluate(definition, $this.product.text),
               task.for = create('Reference') as patientReference, patientReference.reference = evaluate(subject, $this.id.replaceMatches('/_history/.*', '')),
               task.basedOn = reference(careplan),
               task.authoredOn = evaluate(subject, now()),
               task.requester = evaluate(subject, $this.generalPractitioner.first()),
               task.owner = evaluate(subject, $this.generalPractitioner.first()),
               task.code = evaluate(definition, code),
               task.reasonCode = evaluate(definition, product) "rule_task_data";

        subject then extractPeriod(subject, task) "rule_task_period_extraction";

        // subject ->task.status = create('Status') as status then {

            subject where(definition.code.where(coding.code = '001')) then {
                subject -> task.status = 'ready' "embed_2";
            } "rule_status_001";
            subject where(definition.code.where(coding.code = '002')) then {
                subject -> task.status = 'ready' "embed_2";
            } "rule_status_002";
            subject where(definition.code.where(coding.code = '003')) then {
                subject -> task.status = 'ready' "embed_3";
            } "rule_status_003";
            subject where(definition.code.where(coding.code = '004')) then {
                subject -> task.status = 'ready' "embed_4";
            } "rule_status_004";
            subject where(definition.code.where(coding.code = '005')) then {
                subject -> task.status = 'ready' "embed_5";
            } "rule_status_005";
            subject where(definition.code.where(coding.code = '006')) then {
                subject -> task.status = 'ready' "embed_6";
            } "rule_status_006";

            subject where(definition.code.where(coding.code = '007')) then {
                subject -> task.status = 'ready' "embed_7";
            } "rule_status_007";
            subject where(definition.code.where(coding.code = '008')) then {
                subject -> task.status = 'ready' "embed_8";
            } "rule_status_008";

            subject where(definition.code.where(coding.code = '009')) then {
                subject -> task.status = 'requested' "embed_9";
            } "rule_status_009";

            subject where(definition.code.where(coding.code = '010')) then {
                subject -> task.status = 'requested' "embed_10";
            } "rule_status_010";
            subject where(definition.code.where(coding.code = '011')) then {
                subject -> task.status = 'requested' "embed_11";
            } "rule_status_011";
            subject where(definition.code.where(coding.code = '012')) then {
                subject -> task.status = 'requested' "embed_12";
            } "rule_status_012";
            subject where(definition.code.where(coding.code = '013')) then {
                subject -> task.status = 'requested' "embed_13";
            } "rule_status_013";
            subject where(definition.code.where(coding.code = '014')) then {
                subject -> task.status = 'requested' "embed_14";
            } "rule_status_014";

            subject where(definition.code.where(coding.code = '015')) then {
                subject -> task.status = 'requested' "embed_15";
            } "rule_status_015";
            subject where(definition.code.where(coding.code = '016')) then {
                subject -> task.status = 'requested' "embed_16";
            } "rule_status_016";

            subject where(definition.code.where(coding.code = '017')) then {
                subject -> task.status = 'requested' "embed_17";
            } "rule_status_017";

            subject where(definition.code.where(coding.code = '018')) then {
                subject -> task.status = 'requested' "embed_18";
            } "rule_status_018";
            subject where(definition.code.where(coding.code = '019')) then {
                subject -> task.status = 'requested' "embed_19";
            } "rule_status_019";
            subject where(definition.code.where(coding.code = '020')) then {
                subject -> task.status = 'requested' "embed_20";
            } "rule_status_020";
            subject where(definition.code.where(coding.code = '021')) then {
                subject -> task.status = 'requested' "embed_21";
            } "rule_status_021";
            subject where(definition.code.where(coding.code = '022')) then {
                subject -> task.status = 'requested' "embed_22";
            } "rule_status_022";

            subject where(definition.code.where(coding.code = '023')) then {
                subject -> task.status = 'requested' "embed_23";
            } "rule_status_023";
            subject where(definition.code.where(coding.code = '024')) then {
                subject -> task.status = 'requested' "embed_24";
            } "rule_status_024";

            subject where(definition.code.where(coding.code = '025')) then {
                subject -> task.status = 'requested' "embed_25";
            } "rule_status_024";

            subject where(definition.code.where(coding.code = '026')) then {
                subject -> task.status = 'requested' "embed_26";
            } "rule_status_026";
            subject where(definition.code.where(coding.code = '027')) then {
                subject -> task.status = 'requested' "embed_27";
            } "rule_status_027";
            subject where(definition.code.where(coding.code = '028')) then {
                subject -> task.status = 'requested' "embed_28";
            } "rule_status_028";
            subject where(definition.code.where(coding.code = '029')) then {
                subject -> task.status = 'requested' "embed_29";
            } "rule_status_029";
            subject where(definition.code.where(coding.code = '030')) then {
                subject -> task.status = 'requested' "embed_30";
            } "rule_status_030";

            subject where(definition.code.where(coding.code = '031')) then {
                subject -> task.status = 'requested' "embed_31";
            } "rule_status_031";
            subject where(definition.code.where(coding.code = '032')) then {
                subject -> task.status = 'requested' "embed_32";
            } "rule_status_032";

        // } "rule_task_status";

        subject -> task.reasonReference = create('Reference') as reasonReference then {

            subject where(definition.code.where(coding.code = '002')) then {
                subject -> reasonReference.reference = 'Questionnaire/374443' "embed_2";
            } "rule_name_002";
            subject where(definition.code.where(coding.code = '003')) then {
                subject -> reasonReference.reference = 'Questionnaire/381022' "embed_3";
            } "rule_name_003";
            subject where(definition.code.where(coding.code = '004')) then {
                subject -> reasonReference.reference = 'Questionnaire/381023' "embed_4";
            } "rule_name_004";
            subject where(definition.code.where(coding.code = '005')) then {
                subject -> reasonReference.reference = 'Questionnaire/381024' "embed_5";
            } "rule_name_005";
            subject where(definition.code.where(coding.code = '006')) then {
                subject -> reasonReference.reference = 'Questionnaire/381005' "embed_6";
            } "rule_name_006";

            subject where(definition.code.where(coding.code = '007')) then {
                subject -> reasonReference.reference = 'Questionnaire/381030' "embed_7";
            } "rule_name_007";
            subject where(definition.code.where(coding.code = '008')) then {
                subject -> reasonReference.reference = 'Questionnaire/381031' "embed_8";
            } "rule_name_008";

            subject where(definition.code.where(coding.code = '010')) then {
                subject -> reasonReference.reference = 'Questionnaire/381025' "embed_10";
            } "rule_name_010";
            subject where(definition.code.where(coding.code = '011')) then {
                subject -> reasonReference.reference = 'Questionnaire/381026' "embed_11";
            } "rule_name_011";
            subject where(definition.code.where(coding.code = '012')) then {
                subject -> reasonReference.reference = 'Questionnaire/381027' "embed_12";
            } "rule_name_012";
            subject where(definition.code.where(coding.code = '013')) then {
                subject -> reasonReference.reference = 'Questionnaire/381028' "embed_13";
            } "rule_name_013";
            subject where(definition.code.where(coding.code = '014')) then {
                subject -> reasonReference.reference = 'Questionnaire/381029' "embed_14";
            } "rule_name_014";

            subject where(definition.code.where(coding.code = '015')) then {
                subject -> reasonReference.reference = 'Questionnaire/381030' "embed_15";
            } "rule_name_015";
            subject where(definition.code.where(coding.code = '016')) then {
                subject -> reasonReference.reference = 'Questionnaire/381031' "embed_16";
            } "rule_name_016";

            subject where(definition.code.where(coding.code = '018')) then {
                subject -> reasonReference.reference = 'Questionnaire/409077' "embed_18";
            } "rule_name_018";
                subject where(definition.code.where(coding.code = '019')) then {
                subject -> reasonReference.reference = 'Questionnaire/409074' "embed_19";
            } "rule_name_019";
                subject where(definition.code.where(coding.code = '020')) then {
                subject -> reasonReference.reference = 'Questionnaire/409076' "embed_20";
            } "rule_name_020";
                subject where(definition.code.where(coding.code = '021')) then {
                subject -> reasonReference.reference = 'Questionnaire/409075' "embed_21";
            } "rule_name_021";
            subject where(definition.code.where(coding.code = '022')) then {
                subject -> reasonReference.reference = 'Questionnaire/409078' "embed_22";
            } "rule_name_022";

            subject where(definition.code.where(coding.code = '023')) then {
                subject -> reasonReference.reference = 'Questionnaire/381030' "embed_23";
            } "rule_name_023";
                subject where(definition.code.where(coding.code = '024')) then {
                subject -> reasonReference.reference = 'Questionnaire/381031' "embed_24";
            } "rule_name_024";

            subject where(definition.code.where(coding.code = '026')) then {
                subject -> reasonReference.reference = 'Questionnaire/409100' "embed_26";
            } "rule_name_026";
                subject where(definition.code.where(coding.code = '027')) then {
                subject -> reasonReference.reference = 'Questionnaire/409085' "embed_27";
            } "rule_name_027";
                subject where(definition.code.where(coding.code = '028')) then {
                subject -> reasonReference.reference = 'Questionnaire/409093' "embed_28";
            } "rule_name_028";
            subject where(definition.code.where(coding.code = '029')) then {
                subject -> reasonReference.reference = 'Questionnaire/409086' "embed_28";
            } "rule_name_029";
            subject where(definition.code.where(coding.code = '030')) then {
                subject -> reasonReference.reference = 'Questionnaire/409101' "embed_28";
            } "rule_name_030";

            subject where(definition.code.where(coding.code = '031')) then {
                subject -> reasonReference.reference = 'Questionnaire/381030' "embed_28";
            } "rule_name_031";
            subject where(definition.code.where(coding.code = '032')) then {
                subject -> reasonReference.reference = 'Questionnaire/381031' "embed_28";
            } "rule_name_032";

        } "rule_task_questions";

        // task groupIdentifier
        subject -> task.groupIdentifier = create('Identifier') as groupIdentifier then {
            subject -> groupIdentifier.value = evaluate(definition, $this.dosage.skip(version).first().select(timing.repeat.period.toString() + '_' + timing.repeat.periodUnit)) "rule_group_identifierule_value";
            subject -> groupIdentifier.use = "secondary" "rule_group_identifierule_use";
        } "rule_group_identifier";

        // subject -> evaluate(task, $this.groupIdentifier.value) as groupIdentifierValue then {
        //     subject where(groupIdentifierValue = '108_mo') then {
        //         subject -> evaluate(subject, "3285") as maxDays then extractTaskRestriction(subject, task, definition, version, maxDays) "rule_task_restriction";
        //     } "rule_create_restriction_end_duration_9_years";

        //     subject where(groupIdentifierValue = '114_mo') then {
        //         subject -> evaluate(subject, "3467.5") as maxDays then extractTaskRestriction(subject, task, definition, version, maxDays) "rule_task_restriction";
        //     } "rule_create_restriction_end_duration_9half_years";

        //     subject where(groupIdentifierValue != '114_mo' and groupIdentifierValue != "108_mo") then {
        //         subject -> evaluate(subject, "1825") as maxDays then extractTaskRestriction(subject, task, definition, version, maxDays) "rule_task_restriction";
        //     } "rule_create_restriction_end_duration_5_years";
        // } "rule_create_restriction_end_duration";

        //add task.input for task dependencies
        subject -> task.input = create('Task_Input') as inputTask then {
            subject -> inputTask.type = create("CodeableConcept") as concept then {
                subject-> concept.coding = c("http://snomed.info/sct","371154000") as coding then {
                        subject -> coding.display = "Dependent (qualifier value)" "rule_coding_display";
                    } "rule_task_concept_coding";
                } "rule_codeable_concept";
            subject -> inputTask.value = 28 "rule_input_value";//TODO discuss implementation on how we can make this dynamic for each dosage
         } "rule_task_input";

        subject -> evaluate(definition, $this.product.text + ' ' + (currentDose.sequence - 1).toString()) as preReqName,
            evaluate(careplan, $this.contained.where(description.contains(preReqName))) as preReqTask then {
                subject where(preReqTask.exists()) -> task.partOf = create('Reference') as partOfReference then {
                    subject -> partOfReference.reference = evaluate(preReqTask, 'Task/' + id) "rule_task_reference_id";
                } "rule_task_part_of";
            } "rule_dosage";

        subject then extractTaskReferenceInput(subject, task, definition, version, careplan) "rule_task_reference_input";

        // create activity.detail of type/kind Task for this Task if not exists
        subject where(careplan.activity.where(detail.kind = 'Task').exists().not()) -> careplan.activity = create('CarePlan_Activity') as activity then {
            subject -> activity.detail = create('CarePlan_ActivityDetail') as ActivityDefinition then {
                subject -> ActivityDefinition.kind = 'Task' "rule_activity_detail_data";
            } "rule_activity_detail";
        } "rule_careplan_activity";

        // add task to careplan irrespective of its validity
        subject then {
            subject -> evaluate(careplan, activity.where(detail.kind = 'Task')) as activity, activity.outcomeReference = reference(task) "rule_careplan_task_reference";
            subject -> careplan.contained = task "rule_add_task";
        } "rule_careplan_task";
    } "rule_task";
}

group extractTaskReferenceInput(source subject: Patient, target task: Task, source definition: ActivityDefinition, source version: Integer, source careplan: CarePlan) {
    subject -> evaluate(task, $this.partOf.last()) as taskPartOfReference then {
        subject where(taskPartOfReference.empty().not()) then {
            subject -> task.input = create('Task_Input') as inputTask then {
                subject -> inputTask.type = create("CodeableConcept") as concept then {
                    subject-> concept.coding = c("http://snomed.info/sct","900000000000457003") as coding then {
                        subject -> coding.display = "Reference set attribute (foundation metadata concept)" "rule_coding_display";
                    } "rule_task_concept_coding";
                } "rule_codeable_concept";
                subject -> inputTask.value = create('Reference') as partOfReference then {
                        subject -> partOfReference.reference = evaluate(subject, taskPartOfReference.reference.toString()) "rule_task_reference_id";
                } "rule_task_part_of_reference";
            } "rule_task_input";
        } "rule_task_part_of_reference_exists";
    } "rule_task_part_of_reference";
}

// group extractTaskRestriction(source subject: Patient, target task: Task, source definition: ActivityDefinition, source version: Integer, source restrictionEndDate: String) {
//     subject -> evaluate(task, $this.executionPeriod.start) as start then {
//         subject -> evaluate(subject, $this.birthDate) as patientBirthDate then {
//             subject -> create("Task_Restriction") as taskRestriction then {
//                 subject->taskRestriction.period = create("Period") as taskRestrictionPeriod then {
//                     subject -> taskRestrictionPeriod.start = create('dateTime') as startDateTime,
//                         startDateTime.value = evaluate(start, $this.value.substring(0,10) + 'T00:00:00.00Z') "rule_period_start";

//                     subject -> taskRestrictionPeriod.end = create('dateTime') as endDateTime,
//                         endDateTime.value = evaluate(start, (($this + (((restrictionEndDate).toString() + ' \'days\'')).toQuantity()).value.substring(0,10)) + 'T00:00:00.00Z') "rule_period_end";

//                     subject -> task.restriction = taskRestriction "rule_restriction_period";
//                 } "rule_task_restriction_period";
//             } "rule_task_restriction";
//         } "rule_birth_date";
//     } "rule_task_execution_period";
// }

group extractPeriod(source subject: Patient, target task: Task) {
    subject -> evaluate(task, $this.executionPeriod.start) as start, evaluate(task, $this.executionPeriod.end) as end then {
        subject -> create('Period') as period then {
            subject -> period.start = create('dateTime') as startDateTime,
                startDateTime.value = evaluate(start, $this.value.substring(0,10) + 'T00:00:00.00Z') "rule_period_start";

            subject -> period.end = create('dateTime') as endDateTime,
                endDateTime.value = evaluate(end, $this.value.substring(0,10) + 'T00:00:00.00Z') "rule_period_end";

            subject -> task.executionPeriod = period "rule_execution_period";
        } "rule_period";
    } "rule_task_execution_period";
}