{
  "resourceType": "PlanDefinition",
  "id": "132157",
  "url": "https://my-opensrp-server.org/my/globally/unique/url/132157",
  "meta": {
    "versionId": "1",
    "lastUpdated": "2022-06-20T22:30:39.217+00:00"
  },
  "contained": [
    {
      "resourceType": "ActivityDefinition",
      "id": "careplan-init-activity",
      "title": "ANC Register Handler Activity",
      "status": "active",
      "description": "This action will assess careplan on registration to init careplan",
      "kind": "CarePlan",
      "dynamicValue": [
        {
          "path": "title",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%rootResource.title"
          }
        },
        {
          "path": "description",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%rootResource.description"
          }
        },
        {
          "path": "instantiatesCanonical",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%rootResource.id.replaceMatches('/_history/.*', '')"
          }
        },
        {
          "path": "status",
          "expression": {
            "language": "text/fhirpath",
            "expression": "'active'"
          }
        },
        {
          "path": "intent",
          "expression": {
            "language": "text/fhirpath",
            "expression": "'plan'"
          }
        },
        {
          "path": "created",
          "expression": {
            "language": "text/fhirpath",
            "expression": "now()"
          }
        },
        {
          "path": "subject",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.where(resource is QuestionnaireResponse).resource.subject"
          }
        },
        {
          "path": "author",
          "expression": {
            "language": "text/fhirpath",
            "expression": "$this.generalPractitioner.first()"
          }
        },
        {
          "path": "period.start",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.where(resource is QuestionnaireResponse).resource.descendants().where(linkId='245679f2-6172-456e-8ff3-425f5cea3243').answer.value"
          }
        },
        {
          "path": "period.end",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.where(resource is QuestionnaireResponse).resource.descendants().where(linkId='245679f2-6172-456e-8ff3-425f5cea3243').answer.value + 9 'months'"
          }
        },
        {
          "path": "activity.detail.kind",
          "expression": {
            "language": "text/fhirpath",
            "expression": "'Task'"
          }
        },
        {
          "path": "activity.detail.status",
          "expression": {
            "language": "text/fhirpath",
            "expression": "'in-progress'"
          }
        },
        {
          "path": "activity.detail.description",
          "expression": {
            "language": "text/fhirpath",
            "expression": "'This action will assess careplan on registration to init careplan'"
          }
        },
        {
          "path": "activity.detail.performer",
          "expression": {
            "language": "text/fhirpath",
            "expression": "$this.generalPractitioner.first()"
          }
        }
      ]
    },
    {
      "resourceType": "ActivityDefinition",
      "id": "careplan-task-activity",
      "title": "ANC Visits Plan",
      "status": "active",
      "description": "This action will performed every month for a pregnant woman",
      "kind": "Task",
      "timingTiming": {
        "repeat": {
          "count": 8,
          "duration": 1,
          "durationUnit": "mo",
          "period": 1,
          "periodUnit": "mo"
        }
      }
    },
    {
      "resourceType": "ActivityDefinition",
      "id": "careplan-end-activity",
      "title": "Careplan completion Activity",
      "status": "active",
      "description": "This action will assess careplan every time a followup happens on a task generated by plan to mark it complete",
      "kind": "CarePlan",
      "dynamicValue": [
        {
          "path": "status",
          "expression": {
            "language": "text/fhirpath",
            "expression": "'completed'"
          }
        }
      ]
    },
    {
      "resourceType": "ActivityDefinition",
      "id": "careplan-referral-activity",
      "title": "ANC Referral Handler Activity",
      "status": "active",
      "description": "This action will assess careplan and generate referral task every time a followup happens on a task generated by plan",
      "kind": "Task"
    }
  ],
  "name": "ANC Follow Up Plan",
  "title": "ANC Follow Up Plan",
  "status": "active",
  "description": "This defines the schedule of care for pregnant women",
  "action": [
    {
      "prefix": "1",
      "priority": "routine",
      "condition": [
        {
          "kind": "applicability",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.where(resource is QuestionnaireResponse).resource.where(questionnaire = 'Questionnaire/132152').exists()"
          }
        }
      ],
      "definitionCanonical": "#careplan-init-activity"
    },
    {
      "prefix": "1",
      "priority": "routine",
      "condition": [
        {
          "kind": "applicability",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.where(resource is QuestionnaireResponse).resource.where(questionnaire = 'Questionnaire/132152').exists()"
          }
        }
      ],
      "definitionCanonical": "#careplan-task-activity",
      "transform": "http://hl7.org/fhir/StructureMap/132156"
    },
    {
      "prefix": "1",
      "priority": "routine",
      "condition": [
        {
          "kind": "applicability",
          "expression": {
            "language": "text/fhirpath",
            "expression": "$this is Patient and %resource.entry.first().where(resource is QuestionnaireResponse).resource.questionnaire = 'Questionnaire/132170'"
          }
        }
      ],
      "definitionCanonical": "#careplan-end-activity"
    },
    {
      "prefix": "1",
      "priority": "routine",
      "condition": [
        {
          "kind": "applicability",
          "expression": {
            "language": "text/fhirpath",
            "expression": "%resource.entry.first().where(resource is QuestionnaireResponse).resource.descendants().where((linkId='1b625d5c-d0bc-44d5-8eed-3efc37c51f84' or linkId='9b486fa3-5323-47db-c8eb-f725fb50e8d6') and answer.value.code='yes').exists()"
          }
        }
      ],
      "definitionCanonical": "#careplan-referral-activity",
      "transform": "http://hl7.org/fhir/StructureMap/528a8603-2e43-4a2e-a33d-1ec2563ffd3e"
    }
  ]
}