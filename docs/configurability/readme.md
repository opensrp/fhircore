# Documentation of Quest Configuration
<img src="https://user-images.githubusercontent.com/62053304/169209957-e59780e8-4e68-49fc-8167-a247d696d09b.jpg" width="512">
The configurations in *Quest* use a combination of a single `Composition` and multiple `Binary` resource.

## Composition
The `Composition` config is identified using a unique `appId` string and is the entry point to access all the `Binary` configs associated with that `appId`.

### Structure of Composition Config
There are 2 attributes to highlight: the `identifier` and `section` attributes.

These are the only attributes that developers need to specifically fill, the other attributes can be generic by using our own template and some are also automatically generated by the FHIR server.

* `identifier`

   The `identifier` attribute is a single unique value that represents an `appId` and differentiates `Composition` config files.
   
   ```json
   "identifier": {
     "use": "official",
     "value": "appId"
   }
   ```

* `section`

   The `section` attribute is multivalue that represent configurations of specific components of the app.
   
   Each `section` contains:
   
   * `reference` to the `Binary` config associated with the `Composition` `appId`
   
   * `identifier` that represents a config classification name
   
   ```json
   "section": [
    {
      "title": "App configuration",
      "mode": "working",
      "focus": {
        "reference": "Binary/xxxxx",
        "identifier": {
          "value": "application"
        }
      }
    },
    {
      "title": "Login configuration",
      "mode": "working",
      "focus": {
        "reference": "Binary/xxxxx",
        "identifier": {
          "value": "login"
        }
      }
    }
   ]
   ```

## Binary

The `Binary` config contains attributes that will be used in the app.

List of common `Binary` config `classfication`s:

| classification               | What it configures                                                              |
| :----------------------------- | :------------------------------------------------------------------------ |
| application           | Configure the app level                             |
| login                 | Configure the login page                             |
| app_feature           | Configure the available features                             |
| pin                   | Configure the pin setup and pin login page                             |
| data_filters          | Configure the filters when retrieving resource from FHIR local database                       |
| forms                 | Configure the Questionnaire forms that the app will uses                           |
| patient_register      | Configure the patient register page                             |
| sync                  | Configure the resources that will be synced                             |

### Structure of the `Binary` resources

Common attributes:

| Attributes               | Description                                 |
   | :----------------------------- | :------------------------------------------ |
   | appId           | Sets the config identifier e.g anc, ecbis, quest, etc                            | 
   | classification                 | Sets the config classification name e.g application, login, sync, etc         |

#### Structure of each `classification`

1. `application`

   Configure the app level.

   | Attributes               | Description                                 | Type |
   | :----------------------------- | :------------------------------------------ | :---- |
   | theme           | Sets the theme for the app                            | String |
   | language                 | Sets the languages for the app                          | List&lt;String&gt; |
   | syncInterval           | Sets the periodic sync interval in seconds. Default 30            | Long |
   | applicationName                   | Sets the application display name                      | String |
   | appLogoIconResourceFile          | Sets the application logo icon, there must be png file inside  | String       |
   | count                 | Sets the application maximum records when downloading resource                  | String      |
   

   ```json
   {
     "appId": "ecbis-saa",
     "classification": "application",
     "theme": "AppTheme",
     "languages": ["en", "sw"],
     "applicationName": "eCBIS",
     "appLogoIconResourceFile": "ic_liberia",
     "count": "100"
   }
   ```
2. `login`

   Configure the login page.

   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | applicationName           | Sets the application display name                            | String |
   | applicationVersion                 | Set the application display version                        | String |
   | applicationVersionCode           | Set the application version code                 | Int |
   | darkMode                   | Sets the login theme to use dark mode                             | Boolean |
   | showLogo          | Sets the login logo visibility        | Boolean |
   | enablePin                 | Sets the use of pin login feature                         | Boolean |
   
   ```json
   {
     "appId": "ecbis-saa",
     "classification": "login",
     "applicationName": "eCBIS",
     "applicationVersion": "0.0.1",
     "applicationVersionCode": 1,
     "darkMode": false,
     "showLogo": true,
     "enablePin": true
   }
   ```
   
3. `app_feature`

   Configure the available features.

   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | appFeatures           | Sets the list of features in the app                           | List&lt;FeatureConfig&gt; |
   
   #### Structure of `FeatureConfig`
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | feature           | Sets the feature name                            | String |
   | active                 | Sets the feature active status                       | Boolean |
   | settings           | Sets the custom settings of this feature, when needed                 | Map&lt;String, String&gt; |
   | target                   | Sets the user that will use this feature e.g CHW, HF         | String? |
   | healthModule          | Sets the health module of this feature e.g DEFAULT, ANC, RDT, PNC, CHILD, FAMILY, FAMILY PLANNING       | String? |
   | useCases                 | Sets the use cases / what this feature can do e.g PATIENT_REGISTRATION, ANC_VISITS, etc | List&lt;String&gt;? |
   
   ```json
   {
     "appId": "ecbis-saa",
     "classification": "app_feature",
     "appFeatures": [
       {
         "feature": "PatientManagement",
         "active": true,
         "settings": {},
         "target": "CHW",
         "healthModule": "ANC",
         "useCases": [
           "PATIENT_REGISTRATION",
           "ANC_VISITS",
           "PREGNANCY_OUTCOME"
         ]
       },
       {
         "feature": "HouseHoldManagement",
         "active": true,
         "settings": {
           "deactivateMembers": "true"
         },
         "target": "CHW",
         "healthModule": "FAMILY",
         "useCases": [
           "HOUSEHOLD_REGISTRATION",
           "REMOVE_HOUSEHOLD",
           "HOUSEHOLD_VISITS",
           "REMOVE_HOUSEHOLD_MEMBER"
         ]
       }
     ]
   }
   ```
   
3. `pin`

   Configure the pin setup and pin login page.
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | applicationName           | Sets the application display name                            | String |
   | appLogoIconResourceFile          | Sets the application logo icon, there must be png file inside  | String       |
   | showLogo          | Sets the logo visibility        | Boolean |
   
   ```json
   {
     "appId": "ecbis-saa",
     "classification": "pin",
     "applicationName": "eCBIS",
     "appLogoIconResourceFile": "ic_liberia",
     "showLogo": true
   }
   ```

4. `data_filters`

   Configure the filters when retrieving resource from FHIR local database.

   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | filters           | Sets the list of filters in the app                           | List&lt;SearchFilter&gt; |
   
   #### Structure of `SearchFilter`
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | id           | Sets the identifier that is related to the feature or resource that will be filtered e.g family, family_care_plan, task          | List&lt;SearchFilter&gt; |
   | key           | Sets the filter key                       | String |
   | filterType           | Sets the filter type                    | String |
   | valueType           | Sets the value type of the filter                       | String |
   | valueBoolean           | Sets the value if it's a Boolean                       | Boolean? |
   | valueCoding           | Sets the value if it's a Coding                        | Code? |
   | valueString           | Sets the value if it's a String                       | String? |
   
   #### Structure of `Code`
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | system           | Sets the system as url of an org that provides this Code        | String? |
   | code           | Sets the unique code in numeric                     | String? |
   | display           | Sets the human readable meaning of this Code e.g Family              | String? |
   
   #### Currently Supported `filterType` and `valueType`
   
   | filterType               | valueType                                                          |
   | :----------------------------- | :----------------------------------------------------- |
   | TOKEN           | CODING |
   | TOKEN           | CODEABLECONCEPT                       |
   | STRING           | STRING                   |
   | STRING           | BOOLEAN                         |
   
   ```json
   {
     "appId": "ecbis-saa",
     "classification": "data_filters",
     "filters": [
       {
         "id": "anc",
         "filterType": "TOKEN",
         "key": "clinical-status",
         "valueType": "CODEABLECONCEPT",
         "valueCoding": {
           "system": "http://terminology.hl7.org/CodeSystem/condition-clinical",
           "code": "active"
         }
       },
       {
         "id": "family",
         "filterType": "TOKEN",
         "key": "type",
         "valueType": "CODING",
         "valueCoding": {
           "system": "http://hl7.org/fhir/group-type",
           "code": "person"
         }
       },
       {
         "id": "family_care_plan",
         "filterType": "TOKEN",
         "key": "_tag",
         "valueType": "CODING",
         "valueCoding": {
           "system": "https://www.snomed.org",
           "code": "35359004"
         }
       },
       {
         "id": "forms_list",
         "filterType": "TOKEN",
         "key": "context",
         "valueType": "CODING",
         "valueCoding": {
           "system": "http://fhir.ona.io",
           "code": "000002"
         }
       }
     ]
   }
   ```
   
5. `forms`

   Configure the Questionnaire forms that the app uses.

   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | forms           | Sets the list of Questionnaire to be used in the app                           | List&lt;QuestionnaireConfig&gt; |
   
   #### Structure of `QuestionnaireConfig`
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | form           | Sets the unique name of this Questionnaire form      | String |
   | title           | Sets the display title                       | String |
   | identifier           | Sets the actual id of the Questionnaire resource                | String |
   | saveButtonText           | Sets the text of the Questionnaire save button                      | String? |
   | setPractitionerDetails        | Sets whether to append Practitioner details when saving QuestionnaireResponse                   | Boolean |
   | setOrganizationDetails        | Sets whether to append Organization details when saving QuestionnaireResponse                        | Boolean |
   
   ```json
   {
     "appId": "ecbis-saa",
     "classification": "forms",
     "forms": [
       {
         "form": "anc-patient-registration",
         "title": "Enroll as ANC Patient",
         "identifier": "1924"
       },
       {
         "form": "family-member-registration",
         "title": "Add Family Member",
         "identifier": "32821"
       }
     ]
   }
   ```
   
7. `patient_register`

   Configure the patient register page.
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | newClientButtonText           | Sets the text on the add new client button                      | String |
   | registrationForm        | Sets the Questionnaire form id for client registration            | String |
   
   
   ```json
   {
     "appId": "quest",
     "classification": "patient_register",
     "newClientButtonText": "Register new client",
     "registrationForm": "3435"
   }
   ```
8. `sync`

   Configure the resources that will be synced. It contains a list of SearchParameter that could sync each resource with its own request parameter or could also be shared with other resources.
   
   | Attributes               | Description                                                          | Type |
   | :----------------------------- | :------------------------------------------------------------------------ | :--- |
   | resourceType           | Sets the resource type. Always set it as Parameters      | String |
   | parameter           | Sets the list of SearchParameter and resources to be synced      | List&lt;SearchParameter&gt; |
   
   #### Structure of `SearchParameter`
   
   For code reasons, each `SearchParameter` is nested with `resource` attribute.
      
   | Attributes               | Description                                            | Type |
   | :----------------------- | :----------------------------------------------------- | :--- |
   | resourceType   | Sets the resource type. Always set it as SearchParameter         | String |
   | name           | Sets the parameter name, that decides which value to get for the key   | String |
   | code           | Sets the parameter key, that will be used in API request url    | String |
   | base           | Sets the list of Resource to be synced      | List&lt;String&gt; |
   | expression     | Sets the parameter expression, that helps to append the value of that key by matching it with the parameter name  | String |
   
   ```json
   {
     "appId": "ecbis-saa",
     "classification": "sync",
     "resourceType": "Parameters",
     "parameter": [
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "organization",
           "code": "organization",
           "base": [
             "Patient"
           ],
           "expression": "#organization"
         }
       },
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "organization",
           "code": "subject.organization",
           "base": [
             "Encounter",
             "Condition",
             "CarePlan",
             "QuestionnaireResponse",
             "Task"
           ],
           "expression": "#organization"
         }
       },
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "organization",
           "code": "_filter",
           "base": [
             "Observation"
           ],
           "type": "token",
           "expression": "patient.organization eq #organization or focus.subject eq Organization/#organization"
         }
       }
     ]
   }
   ```
   
   For deeper information about `SearchParameter`, please refer to this FHIR documentation:
   
   * List of all `SearchParameter`s in FHIR resources: https://hl7.org/fhir/searchparameter-registry.html
   
   * FHIR Searching: https://hl7.org/fhir/search.html
   
   * Advanced Filtering: https://hl7.org/fhir/search.html#_filter
   
   * Parameters chaining: https://hl7.org/fhir/search.html#chaining
   
## Default Templates

Use these templates as a base. Remember to modify everything that is marked `xxx`. You can get the `Binary` reference id after adding each `Binary` to the server. The recommended approach is first to add the `Binary` resource configs to the server, get each of its id, then append it to the `Composition` resource's `Binary` references and finally add the `Composition` to the server.

1. Composition config

   ```json
   {
     "resourceType": "Composition",
     "status": "final",
     "date": "2022-05-30",
     "type": {
       "coding": [
         {
           "system": "http://snomed.info/sct",
           "code": "1156600005",
           "display": "Device setting parameter"
         }
       ]
     },
     "identifier": {
       "use": "official",
       "value": "xxx"
     },
     "title": "Device configurations",
     "confidentiality": "L",
     "section": [
       {
         "title": "App configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "application" }
         }
       },
       {
         "title": "App Feature configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "app_feature" }
         }
       },
       {
         "title": "Login configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "login" }
         }
       },
       {
         "title": "Pin View configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "pin" }
         }
       },
       {
         "title": "Patient Register configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "patient_register" }
         }
       },
       {
         "title": "Patient Register configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "data_filters" }
         }
       },
       {
         "title": "Forms configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "forms" }
         }
       },
       {
         "title": "Sync configuration",
         "mode": "working",
         "focus": {
           "reference": "Binary/xxx",
           "identifier": { "value": "sync" }
         }
       }
     ]
   }
   ```
   
2. Application config
   
   ```json
   {
     "appId": "xxx",
     "classification": "application",
     "theme": "AppTheme",
     "languages": ["en", "sw"],
     "applicationName": "App Name",
     "appLogoIconResourceFile": "ic_default_logo",
     "count": "100"
   }
   ```
   
3. Login config

   ```json
   {
     "appId": "xxx",
     "classification": "login",
     "applicationName": "App Name",
     "applicationVersion": "0.0.1",
     "darkMode": false,
     "showLogo": true,
     "enablePin": true
   }
   ```

4. App Feature config

   ```json
   {
     "appId": "xxx",
     "classification": "app_feature",
     "appFeatures": [
       {
         "feature": "HouseholdManagement",
         "active": true,
         "settings": {},
         "target": "CHW",
         "healthModule": "FAMILY",
         "useCases": [
           "HOUSEHOLD_REGISTRATION"
         ]
       }
     ]
   }
   ```

5. Pin config

   ```json
   {
     "appId": "xxx",
     "classification": "pin",
     "applicationName": "App Name",
     "appLogoIconResourceFile": "ic_default_logo",
     "showLogo": true
   }
   ```

6. Data Filters config

   ```json
   {
     "appId": "xxx",
     "classification": "data_filters",
     "filters": [
       {
         "id": "forms_list",
         "filterType": "TOKEN",
         "key": "context",
         "valueType": "CODING",
         "valueCoding": {
           "system": "http://fhir.ona.io",
           "code": "000002"
         }
       }
     ]
   }
   ```

7. Forms config

   ```json
   {
     "appId": "xxx",
     "classification": "forms",
     "forms": [
       {
         "form": "family-registration",
         "title": "Add Family",
         "identifier": "82952",
         "saveButtonText": "ADD FAMILY",
         "setPractitionerDetails" : true,
         "setOrganizationDetails" : true
       }
     ]
   }
   ```

8. Patient Register config

   ```json
   {
     "appId": "xxx",
     "classification": "patient_register",
     "newClientButtonText": "ADD FAMILY",
     "registrationForm": "family-registration"
   }
   ```

9. Sync config

   ```json
   {
     "appId": "xxx",
     "classification": "sync",
     "resourceType": "Parameters",
     "parameter": [
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "organization",
           "code": "organization",
           "base": [
             "Patient"
           ],
           "type": "token",
           "expression": "#organization"
         }
       },
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "organization",
           "code": "subject.organization",
           "base": [
             "Encounter",
             "Observation",
             "Condition",
             "CarePlan",
             "QuestionnaireResponse",
             "Task"
           ],
           "type": "token",
           "expression": "#organization"
         }
       },
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "publisher",
           "code": "publisher",
           "base": [
             "Questionnaire"
           ],
           "type": "token",
           "expression": "#publisher"
         }
       },
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "_id",
           "code": "_id",
           "base": [
             "StructureMap"
           ]
         }
       },
       {
         "resource": {
           "resourceType": "SearchParameter",
           "name": "count",
           "code": "_count",
           "base": [
             "Patient",
             "Encounter",
             "Observation",
             "Condition",
             "CarePlan",
             "QuestionnaireResponse",
             "Questionnaire",
             "StructureMap",
             "Task",
             "Group"
           ],
           "type": "token",
           "expression": "#count"
         }
       }
     ]
   }
   ```
   
## Adding Configs to the Server

You can add the configs by opening the links below then go to the CRUD Operations tab.

* For Binary: https://fhir.labs.smartregister.org/resource?serverId=global&pretty=true&_summary=&resource=Binary
* For Composition: https://fhir.labs.smartregister.org/resource?serverId=global&pretty=true&_summary=&resource=Composition
   
## Adding Configs to your Local server

Having local configs is useful so you don't need to rely on the server configs, or when you want to test out configs without chaging the server configs, which may affect other engineer's work.

Steps to add local configs:

1. Create a new Directory using this path `android/quest/src/main/assets/configs/[APP_ID]`
2. Under that newly created Directory, create `json` files for `Composition` and `Binary` configs using this format `config_[CLASSIFICATION].json`

Here's an example of the file structure and naming:

<img width="305" alt="Screen Shot 2022-05-31 at 16 08 42" src="https://user-images.githubusercontent.com/62053304/171137504-0742f5b6-4602-4222-be4f-47367a25f9d5.png">

To use those local configs, you just need to add the `/debug` suffix when you input the appId in the AppSettingActivity.

<img src="https://user-images.githubusercontent.com/62053304/171139363-956a55fb-9e7f-494f-8081-5c9a2e418eb1.png" width="256">
