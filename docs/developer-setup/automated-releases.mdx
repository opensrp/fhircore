import gitlabflow from '../assets/gitlabflow.png';

# Releases

OpenSRP FHIR Core releases occur at most once every 2 weeks, i.e. at the conclusion of a sprint. The release process follows the [gitlab flow](https://docs.gitlab.com/ee/topics/gitlab_flow.html#release-branches-with-gitlab-flow) style described in the following diagram:

<img src={gitlabflow} style={{margin: "2em auto", display:"block"}} />

This allows changes to occur on the code release branch while unrelated code continues being merged into main.

# Code Releases

We conduct code releases with the following steps:

1. Code freeze: the creation of a branch for the code release version as well as the first code release candidate (labeled RC1).
    * For example, for code release version `v0.2.0`, create a branch `opensrp-0.2.0`, a pre-release `opensrp-0.2.0-rc1`, and a tag `opensrp-0.2.0-rc1`
1. Candidate progression: This is followed by 1-2 weeks of QA and error fixing
    * Whenever we find an error in the candidate, open a pull request with a fix for the error against the code release branch (e.g.  `v0.2.0`) and against the `main` branch.
    * Once the error is fixed and merged into the code release branch (multiple errors can be batched), create a new pre-release and tag, e.g. `opensrp-0.2.0-rc2`
1. Repeat step (2.) until QA passes, e.g. with more pre-releases and tags, `opensrp-0.2.0-rc3`, ...
1. Final code release: when the release meets requirements, a final code release, `opensrp-0.2.0` is created, with a tag `v0.2.0`.

# APK Releases

Once a final code release is created, attach a generic flavor APK release e.g. `opensrp-0.2.0.apk` to the release. In addition, attach APK releases for any specific flavors requested, e.g. `opensrp-0.2.0-bunda.apk`, `opensrp-0.2.0-ecbis.apk`, `opensrp-0.2.0-wdf.apk`

## Release automation with tags

As part of integrating Continuous Delivery(CD) into the development lifecycle, CI is set up to generate an APK.

The configuration requires the tag to:
* The product name: _opensrp_
* Followed by the _version_ in the format `[0-9]+.[0-9]+.[0-9]+[0-9a-zA-Z.-]+`
* Followed by an optional _suffix_ depending on the release e.g. `-alpha`, `-rc`, `-beta` e.t.c

The following are all valid tags that will trigger the generation of a release APK
> - opensrp-1.2.0
> - opensrp-1.2.0-alpha
> - opensrp-1.2.0-beta
> - opensrp-1.2.0-rc1

**Note:** e.g. when creating a tag for the _OpenSRP Version 1.2.0_, use the command:

```
git tag -a opensrp-1.2.0 -s  && git push origin opensrp-1.2.0
```

When you run the command, you will be prompted to _add a message_. The message should be of the format:

| Template                                                       | Sample                                                                                                            |
|----------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| <pre> TITLE <br/> - Release note 1<br/> - Release note 2</pre> | <pre> BETA RELEASE <br/> - Adds Login by PIN functionality <br/> - Fixes sync bug causing crash on install </pre> |

**Note:** For convention, the TITLE should be _Capitalized_.

## Deleting a tag
Sometimes you may want to delete a tag, e.g. if you push an incorrect tag, need to update the tag message etc.

For example, to delete the opensrp-1.2.0 tag run the command:

```
git push --delete origin opensrp-1.2.0 && git tag --delete opensrp-1.2.0
```
