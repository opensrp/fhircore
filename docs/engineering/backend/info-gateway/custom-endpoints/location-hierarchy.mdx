# OpenSRP Location Hierarchy Endpoint Documentation

The OpenSRP Location Hierarchy endpoint is designed to efficiently retrieve and manage hierarchical location data within the OpenSRP system. Recent enhancements focus on optimizing data retrieval by utilizing lineage location tags, improving performance and scalability.

## 1. Data Retrieval Process

### Overview
Traditionally, the system fetched child locations by recursively traversing the `Location.partOf` property, which could lead to performance bottlenecks. To address this, the retrieval process now utilizes lineage location tags stored in the `Location.meta.tag` field. These tags contain identifiers of ancestor locations, allowing for direct access to hierarchical data without extensive recursion.

### Allowed Parameters
- **`locationId`** (required): The unique identifier of the location whose hierarchy is to be fetched.
- **`recreate-lineage`** (optional): A boolean flag (`true` or `false`). When set to `true`, it triggers the recalculation and updating of ancestor lineage tags for all `Location` resources in the hierarchy.
- **`hierarchy-root-location`** (optional): Specifies the UUID of the root location for the hierarchy to be updated. If provided, the lineage recalculation process starts from this specified root location.

### Example Request
```http
GET /location/hierarchy?locationId=12345&recreate-lineage=true&hierarchy-root-location=67890
```

### Example Response
```json
{
  "locationId": "12345",
  "name": "Region A",
  "parent": {
    "locationId": "67890",
    "name": "Country X"
  },
  "children": [
    {
      "locationId": "54321",
      "name": "District B",
      "tags": ["urban"]
    },
    {
      "locationId": "98765",
      "name": "District C",
      "tags": ["rural"]
    }
  ]
}
```

## 2. Defining the Location Hierarchy

### Hierarchical Structure
The location hierarchy is structured using the `Location` resource in FHIR, with parent-child relationships defined by the `partOf` property. To enhance performance, each `Location` resource's `meta.tag` field is augmented with lineage tags that include the identifiers of all ancestor locations up to the root. This approach allows for efficient retrieval of hierarchical data without the need for recursive queries.

### Lineage Tag Structure
Each lineage tag is represented as follows:
```json
{
  "system": "http://smartregister.org/CodeSystem/location-lineage",
  "code": "ancestor-location-uuid",
  "display": "Ancestor Location Name"
}
```
These tags are stored in the `meta.tag` field of the `Location` resource and are used to quickly identify and retrieve related locations within the hierarchy.

## 3. Adding Tags to Locations

Tags, including lineage tags, are added to the `Location.meta.tag` field to provide additional metadata and facilitate efficient hierarchy retrieval. The process of adding lineage tags involves traversing the location hierarchy and updating each `Location` resource with the identifiers of its ancestor locations.

### Example of Adding Lineage Tags
When a new location is added or an existing hierarchy is updated, the system can recalculate and update lineage tags by triggering the lineage recalculation process through the `recreate-lineage` parameter.

## 4. Code Snippets

### Fetching Location Hierarchy
The following example demonstrates how to fetch a location hierarchy using a RESTful API call:
```http
GET /location/hierarchy?locationId=12345
```
This request retrieves the hierarchy for the location with ID `12345`.

### Service Logic for Fetching Hierarchy
```java
public LocationHierarchy fetchHierarchy(String locationId, boolean recreateLineage, String rootLocationId) {
    if (recreateLineage) {
        recalculateLineageTags(rootLocationId != null ? rootLocationId : locationId);
    }
    Location root = locationRepository.findById(locationId)
        .orElseThrow(() -> new ResourceNotFoundException("Location not found"));

    return buildHierarchy(root);
}

private void recalculateLineageTags(String rootLocationId) {
    // Logic to traverse the hierarchy and update lineage tags
}

private LocationHierarchy buildHierarchy(Location root) {
    List<Location> children = locationRepository.findChildrenByLineageTag(root.getId());
    List<LocationHierarchy> childHierarchies = children.stream()
        .map(this::buildHierarchy)
        .collect(Collectors.toList());

    return new LocationHierarchy(root.getId(), root.getName(), root.getParentId(), childHierarchies);
}
```
In this example, the `fetchHierarchy` method retrieves the location hierarchy for the specified `locationId`. If `recreateLineage` is `true`, it triggers the recalculation of lineage tags starting from the specified root location. The `buildHierarchy` method constructs the hierarchy by fetching child locations using lineage tags.

By leveraging lineage location tags, the OpenSRP system enhances the efficiency of location hierarchy retrieval, reducing computational overhead and improving performance.

